AC.Retina=AC.Class(),AC.Retina.prototype={__defaultOptions:{attribute:"data-hires",recursive:!0,queueSize:8,publishNotifications:!0},initialize:function(a){if(this._benchmarkTimer=new Date,this._options={},this._globalBlacklist=null,this._tagNameBlacklist=null,this._images=[],this._paused=!1,this._deferredQueue=null,this.__queues=[],AC.Object.synthesize(this),"object"!=typeof a&&(a={}),this.setOptions(AC.Object.extend(AC.Object.clone(this.__defaultOptions),a)),this.__setupGlobalBlacklists(),!AC.Retina.Debug&&this.globalBlacklist().isBlacklisted())return this.replace=AC.Function.emptyFunction,!1;if("undefined"==typeof AC.Retina.imageComponentRegistry&&(AC.Retina.imageComponentRegistry=new AC.Registry(AC.Retina.classNamePrefix())),this.__listenToMediaQueryChange(),AC.Retina.windowHasLoaded)this.__setup();else{var b=this.__setup.bind(this);AC.Element.addEventListener(window,"load",b)}},shouldReplace:function(a,b,c){var d,e,f=new AC.Retina.Image(null,c);if("undefined"==typeof a)try{console.warn("AC.Retina.shouldReplace() expects an argument.")}catch(g){}return!this.globalBlacklist().isBlacklisted()&&(d="string"==typeof a?AC.Retina.imageComponentRegistry.lookup(a):AC.Element.isElement(a)?AC.Retina.imageComponentRegistry.match(a):null!==a&&"object"==typeof a&&AC.Retina.imageComponentRegistry.hasComponent(a)?a:AC.Retina.imageComponentRegistry.lookup("img-tag"),f.setSrc(b||"http://images.apple.com/global/elements/blank.gif"),f.setComponent(d),null!==d&&"object"==typeof d&&"function"==typeof d.context&&(e=d.context("blacklist"),e&&"object"==typeof e))?!e.isBlacklisted(null,f):!1},bestSrc:function(a,b,c,d){if("string"!=typeof a)throw"Need a source string to get hires src.";var e=new AC.Retina.Image(null,d);return"string"==typeof b&&(b=AC.Retina.imageComponentRegistry.lookup(b)),null!==b&&"object"==typeof b&&AC.Retina.imageComponentRegistry.hasComponent(b)||(b=AC.Retina.imageComponentRegistry.lookup("img-tag")),e.setSrc(a),e.setComponent(b),"function"==typeof c&&e.checkExists(c,a),e.isHires()||e.ignored()||!this.shouldReplace(b,a,b)?a:e.hiresSrc()},replace:function(a,b){"undefined"==typeof this.__boundAddToQueue&&(this.__boundAddToQueue=this.__addToQueue.bind(this));var c;if(a=AC.Element.getElementById(a),b=AC.Element.getElementById(b),!AC.Element.isElement(a))throw"Cannot replace content because scopeElement is not valid";c=this.__findDenotedElements(a,b),c.length<1||(this.__filterDenotedImages(c),this.__filterChildImages(c),this.__replaceQueues())},paused:function(){return this._paused!==!0||this.deferredQueue()||this.setDeferredQueue(new AC.DeferredQueue),this._paused},pause:function(){this.paused()||this.setPaused(!0)},resume:function(){this.paused()&&(this.setPaused(!1),this.deferredQueue()&&(this.deferredQueue().start(),this.setDeferredQueue(null)))},publishNotification:function(a,b){"object"==typeof AC.NotificationCenter&&this.options().publishNotifications===!0&&AC.NotificationCenter.publish(AC.Retina.classNamePrefix()+a,{target:this,data:b})},subscribeToNotification:function(a,b){"object"==typeof AC.NotificationCenter&&this.options().publishNotifications===!0&&AC.NotificationCenter.subscribe(AC.Retina.classNamePrefix()+a,b,this)}},AC.Retina.rasterImageFormatRegExp=function(){return AC.Retina._rasterImageFormatRegExp},AC.Retina._rasterImageFormatRegExp=/(\.jpg($|#.*|\?.*)|\.png($|#.*|\?.*)|\.gif($|#.*|\?.*))/,AC.Retina.devicePixelRatio=function(){if("undefined"!=typeof AC.Retina._devicePixelRatio)return AC.Retina._devicePixelRatio;var a=!1,b=null;return null!==AC.Retina.minDPRMediaQuery()&&(b=window.matchMedia("("+AC.Retina.minDPRMediaQuery()+": "+AC.Retina.minDPR()+")"),a=b.matches),null===b&&(a="undefined"!=typeof window.devicePixelRatio&&window.devicePixelRatio>=AC.Retina.minDPR()),AC.Retina._devicePixelRatio=AC.Retina.Debug||a===!0?2:1,AC.Retina._devicePixelRatio},AC.Retina.minDPRMediaQuery=function(){if("undefined"!=typeof AC.Retina._minDPRMediaQuery)return AC.Retina._minDPRMediaQuery;var a,b,c=["min-device-pixel-ratio","-webkit-min-device-pixel-ratio","min--moz-device-pixel-ratio","-o-min-device-pixel-ratio"];if("undefined"!=typeof window.matchMedia)for(a=0;a<c.length;a+=1)if(b=window.matchMedia("("+c[a]+": 0)"),b.matches===!0)return AC.Retina._minDPRMediaQuery=c[a],AC.Retina._minDPRMediaQuery;return AC.Retina._minDPRMediaQuery=null,AC.Retina._minDPRMediaQuery},AC.Retina.classNamePrefix=function(){return AC.Retina._classNamePrefix},AC.Retina._classNamePrefix="ac-retina-",AC.Retina.minDPR=function(){return AC.Retina._minDPR},AC.Retina._minDPR=1.5,AC.Retina.windowHasLoaded=!1,AC.Element.addEventListener(window,"load",function(){AC.Retina.windowHasLoaded=!0}),AC.Retina.iOSHandheld=function(){return AC.log("AC.Retina.iOSHandheld is deprecated. For use outside of AC.Retina, use AC.Environment methods instead."),AC.Retina.Blacklist.Qualifiers.iOSHandheld()},AC.Object.extend(AC.Retina.prototype,{__setupGlobalBlacklists:function(){this.setGlobalBlacklist(new AC.Retina.Blacklist([AC.Retina.Blacklist.Qualifiers.iOSHandheld,AC.Retina.Blacklist.Qualifiers.antiquatedBrowser])),this.setTagNameBlacklist(new AC.Retina.Blacklist([AC.Retina.Blacklist.Qualifiers.restrictedTagName]))},__listenToMediaQueryChange:function(){var a,b=this,c=function(){a.matches===!0&&(delete AC.Retina._devicePixelRatio,AC.Retina.windowHasLoaded&&b.replace(document.body),a.removeListener(c))};AC.Retina.devicePixelRatio()<AC.Retina.minDPR()&&null!==AC.Retina.minDPRMediaQuery()&&(a=window.matchMedia("("+AC.Retina.minDPRMediaQuery()+": "+AC.Retina.minDPR()+")"),"function"==typeof a.addListener&&a.matches===!1&&a.addListener(c))},__setup:function(){this.replace(document.body)},__findDenotedElements:function(a,b){var c=this.__denotedElements(a);return AC.Element.isElement(b)?AC.Retina.__isRecursivelyDenoted(b,this.options().attribute)&&c.push(a):AC.Retina.__nearestAncestorHasAttribute(a,this.options().attribute,"true")&&c.push(a),this.publishNotification("foundDenotedElements",c),c},__filterDenotedImages:function(a){var b=this.__filterElements(a);this.publishNotification("filteredDenotedImages",b),b.length>0&&(b.forEach(this.__boundAddToQueue),this.publishNotification("queuedDenotedImages",this.__queues[this.__queues.length-1]))},__filterChildImages:function(a){var b,c;if(this.options().recursive===!0)for(c=0;c<a.length;c+=1)b=this.__imagesWithinElement(a[c]),this.publishNotification("filteredChildImages",b),b.length>0&&(this.__createQueue(),b.forEach(this.__boundAddToQueue),this.publishNotification("queuedChildImages",this.__queues[this.__queues.length-1]))},__createQueue:function(){var a=new AC.Retina.Queue(this.options().queueSize);this.__queues.push(a)},__addToQueue:function(a){(0===this.__queues.length||this.__queues[this.__queues.length-1].ran()===!0)&&this.__createQueue(),this.__queues[this.__queues.length-1].add(a)},__isInQueue:function(a){var b;for(b=0;b<this.__queues.length;b+=1)if(-1!==this.__queues[b].queue().indexOf(a))return!0;return!1},__denotedElements:function(a){a="undefined"==typeof a?document.body:AC.Element.getElementById(a);var b=AC.Element.selectAll("["+this.options().attribute+'="true"]',a);return b},__imagesWithinElement:function(a){var b,c,d=this.__filterElement.bind(this),e=this.tagNameBlacklist(),f=[];for(a=AC.Element.getElementById(a),b=function(a){return!e.isBlacklisted(a)&&d(a)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP},b.acceptNode=b,c=document.createTreeWalker(a,NodeFilter.SHOW_ELEMENT,b,!1);c.nextNode();)AC.Retina.Image.isImage(c.currentNode.ac_retina_image)&&f.push(c.currentNode.ac_retina_image);return f},__filterElements:function(a){var b,c=[];for(b=0;b<a.length;b+=1)this.__filterElement(a[b])&&c.push(a[b].ac_retina_image);return c},__filterElement:function(a){var b,c=a.ac_retina_image;if(!AC.Retina.__isRecursivelyDenoted(a,this.options().attribute))return!1;if(AC.Retina.Image.isImage(c)===!1)b=this.__optionsFromElement(a),c=new AC.Retina.Image(a,b),a.ac_retina_image=c;else if(c.replaced())return!1;return this.__matchComponentToElement(a)===!1?!1:this.__filterImage(c)?(this.images().push(c),!0):!1},__matchComponentToElement:function(a){var b,c=a.ac_retina_image;if(AC.Retina.Image.isImage(c)===!1)throw"Element is missing AC.Retina.Image object.";return b=AC.Retina.imageComponentRegistry.match(a),b&&"_base"!==b.name()?(c.setStatus("is-image"),c.setComponent(b),!0):(c.setStatus("not-image"),!1)},__filterImage:function(a){var b;if(AC.Retina.Image.isImage(a)===!1)throw"Element is missing AC.Retina.Image object.";return a.isHires()?(a.setStatus("already-hires"),!1):a.ignored()?(a.setStatus("ignored"),!1):(b=a.component().context("blacklist"),AC.Retina.Blacklist.isBlacklist(b)&&b.isBlacklisted(a.element(),a)?(a.setStatus("blacklisted"),!1):!0)},__optionsFromElement:function(a){var b,c={},d=a.getAttribute(this.options().attribute+"-options");if(d)for(d=d.split(","),b=0;b<d.length;b+=1){d[b]=d[b].split(":"),c[d[b][0]]=d[b][1];try{c[d[b][0]]=JSON.parse(c[d[b][0]])}catch(e){}c[d[b][0].camelize()]=c[d[b][0]]}return c},__replaceQueues:function(){"function"!=typeof this.__boundReplaceQueues&&(this.__boundReplaceQueues=this.__replaceQueues.bind(this));var a;this.__queues.length>0&&(a=this.__queues[0],this.__queues.splice(0,1),a.run("replace",this.__boundReplaceQueues))}}),AC.Retina.__isRecursivelyDenoted=function(a,b){return"true"===a.getAttribute(b)||AC.Retina.__nearestAncestorHasAttribute(a,b,"true")&&"false"!==a.getAttribute(b)?!0:!1},AC.Retina.__nearestAncestorHasAttribute=function(a,b,c){var d,e=AC.Retina.__ancestors(a);for(d=0;d<e.length;d+=1)if(e[d].hasAttribute(b))return"undefined"==typeof c||e[d].getAttribute(b)===c?e[d]:null;return null},AC.Retina.__ancestors=function(a){a=AC.Element.getElementById(a);var b=[];if(AC.Element.isElement(a.parentNode))for(;a=a.parentNode;)AC.Element.isElement(a)&&b.push(a);return b},AC.Retina.Blacklist=AC.Class(),AC.Retina.Blacklist.prototype={initialize:function(a){this._qualifiers=[],AC.Object.synthesize(this),"undefined"!=typeof a&&this.addQualifier(a)},addQualifier:function(a){var b;if("function"==typeof a)this.qualifiers().push(a);else if(Array.isArray(a)&&a.length>0)for(b=0;b<a.length;b++)this.addQualifier(a[b])},isBlacklisted:function(a,b){var c;for(c=0;c<this.qualifiers().length;c++)if(this.qualifiers()[c].call(b||this,a))return!0;return!1}},AC.Retina.Blacklist.isBlacklist=function(a){return a instanceof AC.Retina.Blacklist},AC.Retina.Blacklist.Qualifiers={},AC.Retina.Blacklist.Qualifiers.DPRLessThanMinAndNotSVG=function(){return"svg"!==this.options().hiresFormat&&AC.Retina.devicePixelRatio()<AC.Retina.minDPR()},AC.Retina.Blacklist.Qualifiers.iOSHandheld=function(){return AC.Environment.Feature.isHandheld()&&"iOS"===AC.Environment.Browser.os},AC.Retina.Blacklist.Qualifiers.antiquatedBrowser=function(){return-1!==AC.Environment.Browser.name.indexOf("Safari")&&AC.Environment.Browser.version<5||"IE"===AC.Environment.Browser.name&&AC.Environment.Browser.version<9||"Firefox"===AC.Environment.Browser.name&&AC.Environment.Browser.version<5||"Chrome"===AC.Environment.Browser.name&&AC.Environment.Browser.version<16?!0:!1},AC.Retina.Blacklist.Qualifiers.restrictedTagName=function(a){var b=["object","param","embed","source"];return!AC.Element.isElement(a)||b.indexOf(a.tagName.toLowerCase())>=0?!0:!1},AC.Retina.Image=AC.Class(),AC.Retina.Image.prototype={initialize:function(a,b){this._options=b||{},this._element=AC.Element.getElementById(a),this._component=null,this._status="considered",this._isPreloaded=!1,this._replaced=!1,this._exists=null,this._ignored=null,this._src=null,this._hiresSrc=null,this._srcFormat=null,this._isHires=null,this._width=null,this._height=null,AC.Object.synthesize(this),AC.Element.isElement(this.element())&&"img"===this.element().tagName.toLowerCase()&&("undefined"!=typeof this.element().naturalWidth&&0!==this.element().naturalWidth&&this.setWidth(this.element().naturalWidth),"naturalHeight"!=typeof this.element().naturalWidth&&0!==this.element().naturalHeight&&this.setHeight(this.element().naturalHeight))},setComponent:function(a){return"object"==typeof a&&null===this.component()?(this._component=a,this.setOptions(AC.Object.extend(AC.Retina.Image.convertParametersToObject(this.src()),this.options())),this.setOptions(AC.Object.extend(AC.Object.clone(a.properties()),this.options())),"undefined"!=typeof this.options().hiResFormat&&(this.options().hiresFormat=this.options().hiResFormat),this.component()):void 0},setStatus:function(a){return"string"!=typeof a?!1:("undefined"!=typeof AC.Retina.Debug&&(AC.Retina.Debug.sharedInstance().addStatus(a),AC.Element.isElement(this.element())&&this.element().setAttribute("data-hires-status",a)),this._status=a,this._status)},__memoizedContextGetter:function(a){if(this.component()){if("function"!=typeof this["__"+a]){var b=this.component().context(a);this["__"+a]="function"==typeof b?b.bind(this):AC.Function.emptyFunction}return this["__"+a]()}throw"Component not assigned yet."},src:function(){return null!==this._src?this._src:(this.setSrc(this.__memoizedContextGetter("src")),this._src)},hiresSrc:function(){if(null!==this._hiresSrc)return this._hiresSrc;if(this.ignored())return this.setHiresSrc(this.src()),this._hiresSrc;var a=this.__memoizedContextGetter("hiresSrc");return this.options().cleanHiresSrc===!0&&(a=a.replace(/((\?.*)|(#.*))$/,"")),this.setHiresSrc(a),this._hiresSrc},srcFormat:function(){if(null!==this._srcFormat)return this._srcFormat;var a=this.src().match(/^.*\.([a-z]*)($|#.*|\?.*)/i);return this.setSrcFormat(null===a?null:a[1]),this._srcFormat},isHires:function(){if(this._isHires===!0)return this._isHires;var a=this.src();return null===a.match(AC.Retina.rasterImageFormatRegExp())||this.replaced()===!0?(this.setIsHires(!0),this._isHires):(this.setIsHires(!1),this._isHires)},ignored:function(){return this.replaced()?(this.setIgnored(!1),this._ignored):null!==this._ignored?this._ignored:(this.setIgnored(!!this.src().match(this.options().ignoreRegex)),this._ignored)},replace:function(a){var b,c=this;return c.replaced()===!0||c.exists()===!1?a():c.options().checkExists===!0&&"boolean"!=typeof c.exists()?void c.checkExists.call(c,function(b){c.setExists(b),c.exists()||c.setStatus("404"),c.replace(a)}):(b=function(b){var d=function(){c.__memoizedContextGetter("replace"),c.setStatus("replaced"),c.setReplaced(!0)};b&&(AC.Retina.sharedInstance().paused()?AC.Retina.sharedInstance().deferredQueue().add(d):d()),"function"==typeof a&&a()},c.setStatus("replacing"),void(c.options().preload||c.options().preloadIfNoDimensions&&(!c.width()||!c.height())?c.preload(b):b(!0)))},checkExists:function(a,b){var c=this;"undefined"==typeof b&&(b=c.hiresSrc()),(c.options().checkAsRootRelative===!0||0===b.indexOf(window.location.origin)||0===b.indexOf("/"))&&(b=c.options().checkAsRootRelative===!0?b.replace(/^https?:\/\/[^\/]*\//,"/"):b,"object"==typeof AC.Ajax&&AC.Ajax.checkURL(b,a))},preload:function(a){var b,c=this;return c.isPreloaded()===!0?a(!0):c.exists()===!1?a(!1):(c.setStatus("loading"),b=new Image,AC.Element.addEventListener(b,"load",function(){c.setIsPreloaded(!0),c.setWidth(b.width/AC.Retina.devicePixelRatio(AC.Retina.minDPR())),c.setHeight(b.height/AC.Retina.devicePixelRatio(AC.Retina.minDPR())),c.setStatus("loaded"),"function"==typeof a&&a(!0)}),c.options().checkExists===!0&&AC.Element.addEventListener(b,"error",function(){c.setStatus("404"),c.setExists(!1),"function"==typeof a&&a(!1)}),void(b.src=c.hiresSrc()))}},AC.Retina.Image.isImage=function(a){return a instanceof AC.Retina.Image},AC.Retina.Image.removeCSSURLSyntax=function(a){var b;return"string"==typeof a&&"function"==typeof a.replace&&(b=a.match(/url\((\'|\")?([^\"\'\)]+)(\'|\")?\)/i))?b[2]:""},AC.Retina.Image.replaceExtension=function(a,b){var c=a.match(/^(.*)((\.[a-z]{3})($|#.*|\?.*))/i);return null!==c&&c.length>1?c[1]+"."+b+(c[4]||""):void 0},AC.Retina.Image.convertParametersToObject=function(a){if("string"==typeof a&&"function"==typeof a.toQueryParams){var b,c={},d=a.toQueryParams();for(b in d)d.hasOwnProperty(b)&&"undefined"!=typeof d[b]&&(c[b.camelize()]=d[b]);return c}return{}},AC.Retina.Queue=AC.Class(),AC.Retina.Queue.prototype={initialize:function(a,b){this._threadCount=a,this._queue=[],"undefined"!=typeof b&&this.add(b),this._ran=!1,AC.Object.synthesize(this)},add:function(a){if(this._ran!==!0){var b;if(Array.isArray(a))for(b=0;b<a.length;b++)this.add(a[b]);else AC.Retina.Image.isImage(a)&&(this._queue.push(a),"function"==typeof a.setStatus&&a.setStatus("queued"))}},run:function(a,b){if(this._ran!==!0){var c=this,d=c._queue.slice(0).reverse(),e=d.length<c._threadCount?d.length:c._threadCount,f=e;c._ran=!0;var g=function i(){var e=d.pop();if("undefined"==typeof e){if(f--,0===f)return"function"==typeof b&&b(),void AC.Retina.sharedInstance().publishNotification("queueEmptied",c)}else"function"==typeof a?a.apply(e,[e,i]):"string"==typeof a&&"function"==typeof e[a]&&e[a].apply(e,[i])},h=function(){var a;for(a=0;e>a;a++)g()};window.setTimeout(h,10)}}},AC.Retina.version="3.0","undefined"==typeof AC.Retina.imageComponentRegistry&&(AC.Retina.imageComponentRegistry=new AC.Registry(AC.Retina.classNamePrefix(),{contextInherits:["src","hiresSrc","replace","blacklist"]})),AC.Retina.imageComponentRegistry.addComponent("_base",{ignoreRegex:/(^http:\/\/movies\.apple\.com\/|\/105\/|\/media\/|\/global(\/ac_media_player)?\/elements\/quicktime\/|_(([2-9]|[1-9][0-9]+)x|nohires)(\.[a-z]+)($|#.*|\?.*))/i,filenameRegex:/(.*)(\.[a-z]{3}($|#.*|\?.*))/i,filenameInsert:"_☃x",hiresFormat:!1,cleanHiresSrc:!0,preload:!1,checkExists:!0,checkAsRootRelative:!0},AC.Function.emptyFunction,null,{src:function(){return""},hiresSrc:function(){var a,b=this.src(),c=this.options().hiresFormat,d=this.srcFormat();return"string"==typeof c&&c!==d?AC.Retina.Image.replaceExtension(b,c):(a=this.src().match(this.options().filenameRegex),null===a?null:a[1]+this.options().filenameInsert.replace("☃",AC.Retina.devicePixelRatio(AC.Retina.minDPR()))+a[2])},replace:AC.Function.emptyFunction,blacklist:new AC.Retina.Blacklist}),AC.Retina.imageComponentRegistry.addComponent("background-image",{preload:!0},function(a){var b=AC.Element.getStyle(a,"background-image");return"img"!==a.tagName.toLowerCase()&&b&&!!b.match(/^url\(([^\)]+)\)$/i)},"_base",{src:function(){return AC.Retina.Image.removeCSSURLSyntax(AC.Element.getStyle(this.element(),"background-image"))},replace:function(){var a=AC.Element.getStyle(this.element(),"background-size");(!a||a.match("auto"))&&AC.Element.setStyle(this.element(),"background-size:"+this.width()+"px "+this.height()+"px;"),AC.Element.setStyle(this.element(),"background-image:url("+this.hiresSrc()+");")},blacklist:new AC.Retina.Blacklist([AC.Retina.Blacklist.Qualifiers.DPRLessThanMinAndNotSVG])}),AC.Retina.imageComponentRegistry.addComponent("img-tag",{preloadIfNoDimensions:!0},function(a){return"img"===a.tagName.toLowerCase()&&!!a.getAttribute("src")},"_base",{src:function(){return this.element().getAttribute("src")},replace:function(){isNaN(parseInt(this.element().getAttribute("width"),10))&&this.width()&&this.element().setAttribute("width",this.width()),isNaN(parseInt(this.element().getAttribute("height"),10))&&this.height()&&this.element().setAttribute("height",this.height()),this.element().setAttribute("src",this.hiresSrc())},blacklist:new AC.Retina.Blacklist([AC.Retina.Blacklist.Qualifiers.DPRLessThanMinAndNotSVG])}),AC.Retina.sharedInstance();